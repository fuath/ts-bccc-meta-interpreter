<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Electron Hello World!</title>
  <style>
    .code {
      font-family: monospace;
      text-shadow: 0 1px #fff;
      direction: ltr;
      text-align: left;
      word-spacing: normal;
      word-break: normal;
      word-wrap: normal;
      width:45%;
      height:600px;
      overflow-y: scroll;
      float:left
    }
  </style>
</head>

<body id="app">

  </div>
  <button id="step-fwd" style="position:absolute; bottom:20px">
    Next
  </button>

  <button id="reload" style="position:absolute; bottom:20px; left:150px">
    Reset
  </button>

  <script>
    let sharedObject = require('electron').remote.getGlobal('sharedObject')
    // document.write(sharedObject.language.ImpLanguageWithSuspend.test_imp())
    let app = document.getElementById("app")

    let code = document.getElementById("code")
    let state = document.getElementById("state")
    let clear_state = () => { while (state.hasChildNodes()) state.removeChild(state.lastChild) }
    let debugger_stream = sharedObject.language.ImpLanguageWithSuspend.get_stream(code.value)

    let reset_state = () => {
      debugger_stream = sharedObject.language.ImpLanguageWithSuspend.get_stream(code.value)
      clear_state()
    }
    let reload = document.getElementById("reload")
    code.onchange = reset_state
    reload.onclick = reset_state
    let next_step = () => {
      clear_state()

      let make_inner_table = (v) => {
        let inner_table = document.createElement("table")
        v.forEach((v,k) => {
          let row = document.createElement("tr")
          let col = document.createElement("td")
          col.innerText = k
          row.appendChild(col)
          col = document.createElement("td")
          if (v.k == "i")
            col.innerText = v.v
            else if (v.k == "render-grid") {
            let canvas = document.createElement("canvas")
            canvas.width = 128
            canvas.height = 128
            let ctx = canvas.getContext("2d")
            let w = v.v.width
            let h = v.v.height
            let cell_w = canvas.width / w
            let cell_h = canvas.height / h
            let pixels = v.v.pixels
            pixels.forEach((col,x) => {
              col.forEach(y => {
                ctx.fillRect(x*cell_w,y*cell_h, cell_w,cell_h)
              })
            })
            col.appendChild(canvas)
          } else if (v.kind == "int")
          col.innerText = "int"
          else
          col.innerText = JSON.stringify(v)
          row.appendChild(col)
          inner_table.appendChild(row)
        })
        return inner_table
      }

      let to_table = (content) => {
        if (content == undefined) return document.createElement("div")
        let values_table = document.createElement("table")

        let keys_to_try = ["bindings", "globals"]

        keys_to_try.forEach(k => {
          if (k in content) {
            let v = content[k]
            let row = document.createElement("tr")
            let col = document.createElement("td")
            col.innerText = k
            row.appendChild(col)
            col = document.createElement("td")
            col.appendChild(make_inner_table(v))

            row.appendChild(col)
            values_table.appendChild(row)
          }
        })

        if ("stack" in content) {
        let stack_row = document.createElement("tr")
        values_table.appendChild(stack_row)
        let stack_col = document.createElement("td")
        stack_col.innerText = "stack"
        stack_row.appendChild(stack_col)
        stack_col = document.createElement("td")
        stack_row.appendChild(stack_col)
        content["stack"].forEach((v,k) => {
            let row = document.createElement("tr")
            let col = document.createElement("td")
            col.appendChild(make_inner_table(v))
            row.appendChild(col)
            stack_col.appendChild(row)
          })
        }

        return values_table
      }

      let state_to_show = debugger_stream.show()
      // console.log(JSON.stringify(state_to_show))
      state.appendChild(to_table(state_to_show))

      if (debugger_stream.kind == "step")
        debugger_stream = debugger_stream.next()
    }
    document.getElementById("step-fwd").onclick = next_step
    app.onkeypress = (k) => {
      // console.log(k.keyCode)
      if (k.keyCode == 14 && k.ctrlKey == true)
        next_step()
      if (k.keyCode == 19 && k.ctrlKey == true)
        reset_state()
    }
  </script>
</body>

</html>